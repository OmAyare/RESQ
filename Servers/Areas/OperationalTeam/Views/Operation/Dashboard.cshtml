@{
    ViewBag.Title = "Live Tracking Dashboard";
    Layout = "~/Areas/OperationalTeam/Views/Shared/_Layout1.cshtml";
}

<h3>India Emergency Activity Dashboard</h3>
<form method="get">
    <label><b>Select Year:</b></label>
    <select name="year" onchange="this.form.submit()">
        @foreach (var y in ViewBag.Years)
        {
            <option value="@y" @(y == ViewBag.SelectedYear ? "selected" : "")>@y</option>
        }
    </select>
</form>

<div id="indiaMap" style="max-width:1100px;">
    @Html.Raw(System.IO.File.ReadAllText(Server.MapPath("~/Content/maps/india.svg")))
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const selectedYear = @ViewBag.SelectedYear;

    function updateMap(data) {

        const countMap = {};
        data.forEach(s => {
            if (s.State) {
                countMap[s.State.trim().toLowerCase()] = s.Count;
            }
        });

        document.querySelectorAll("svg text").forEach(t => t.remove());

        document.querySelectorAll("svg path[aria-label]").forEach(path => {

            const stateName = path.getAttribute("aria-label").trim().toLowerCase();
            const count = countMap[stateName];

            if (count === undefined) return;

            const bbox = path.getBBox();
            const svg = path.ownerSVGElement;

            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute("x", bbox.x + bbox.width / 2);
            text.setAttribute("y", bbox.y + bbox.height / 2);
            text.setAttribute("text-anchor", "middle");
            text.setAttribute("dominant-baseline", "middle");
            text.setAttribute("font-size", "12");
            text.setAttribute("font-weight", "bold");
            text.setAttribute("fill", "#ffffff");

            text.textContent = count;
            svg.appendChild(text);
        });
    }

    function refreshDashboard() {
        $.get('@Url.Action("GetDashboardData", "Operation")',
            { year: selectedYear },
            function (data) {
                updateMap(data);
            });
    }

    refreshDashboard();

    setInterval(refreshDashboard, 5000);
</script>
